<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inbox - {{ short_name }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/alpinejs" defer></script>
</head>
<body class="bg-gray-100 font-sans" x-data="inboxApp()" x-init="init()">
  <div class="flex flex-col md:flex-row min-h-screen">
    {% include 'sidebar.html' %}

    <main class="flex-1 p-4 sm:p-6 overflow-auto">
      <header class="mb-4 sm:mb-6">
        <h1 class="text-xl sm:text-2xl font-semibold">Inbox - {{ user.name }}</h1>
      </header>

      <section class="bg-white p-4 sm:p-6 rounded shadow w-full max-w-3xl mx-auto">
        <h2 class="text-lg font-semibold mb-4">Users Who Sent Messages</h2>
        <div class="flex flex-col gap-3">
          {% for u in user_list %}
          <div class="flex justify-between items-center bg-blue-600 text-white rounded hover:bg-blue-700">
            <button
              class="flex-1 text-left px-4 py-2 truncate"
              @click="openChat('{{ u.email }}', '{{ u.name }}')"
            >
              <div class="font-semibold flex items-center">
                {{ u.name }}
                {% if u.has_unread %}
                <span class="ml-2 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                {% endif %}
              </div>
              <div class="text-sm truncate">{{ u.email }}</div>
            </button>
            <button
              class="px-3 py-2 hover:bg-red-600 rounded-r"
              @click="deleteUserChat('{{ u.email }}')"
              title="Delete Chat"
            >
              üóëÔ∏è
            </button>
          </div>
          {% endfor %}
        </div>
      </section>
    </main>
  </div>

  <!-- Chat Modal -->
  <div
    x-show="showChat"
    x-cloak
    class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4"
  >
    <div class="bg-white rounded-lg w-full max-w-lg p-4 sm:p-6 shadow relative flex flex-col max-h-[90vh] overflow-y-auto">
      <!-- Modal Header -->
      <div class="flex justify-between items-center mb-2">
        <h3 class="text-lg sm:text-xl font-semibold">Chat with <span x-text="currentName"></span></h3>
        <div class="flex items-center space-x-3 relative" x-data="{ open: false }">
          <button
            @click="open = !open"
            class="text-sm text-red-600 hover:underline"
            title="Clear Chat Options"
          >üßπ</button>
          <div
            x-show="open"
            @click.away="open = false"
            class="absolute right-0 top-6 bg-white border rounded shadow w-40 z-10"
          >
            <button @click="clearChat('me')" class="block w-full text-left px-4 py-2 hover:bg-gray-100">Clear for Me</button>
            <button @click="clearChat('both')" class="block w-full text-left px-4 py-2 hover:bg-gray-100">Clear for Both</button>
          </div>
          <button
            class="text-sm text-gray-600 hover:text-black"
            @click="showChat = false"
            title="Close"
          >‚úñ</button>
        </div>
      </div>

      <!-- Chat Area -->
      <div class="border p-3 h-64 sm:h-80 overflow-y-auto space-y-2 mb-3 bg-gray-50 rounded" id="chatMessages"></div>

      <!-- Message Form -->
      <form @submit.prevent="sendMessage" class="flex mt-2 gap-2">
        <input
          x-ref="input"
          type="text"
          x-model="newMessage"
          placeholder="Type your message..."
          class="flex-1 border rounded px-3 py-2"
          required
        />
        <button class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700">Send</button>
      </form>
    </div>
  </div>

  <!-- Alpine Script -->
  <script>
    function inboxApp() {
      return {
        showChat: false,
        currentEmail: '',
        currentName: '',
        newMessage: '',
        messages: [],

        async init() {
          const params = new URLSearchParams(window.location.search);
          const email = params.get('email');
          const name = params.get('name');
          if (email && name) {
            await this.openChat(email, name);
          }
        },

        async openChat(email, name) {
          this.currentEmail = email;
          this.currentName = name;
          this.showChat = true;
          this.newMessage = '';
          await this.loadMessages();
          this.$nextTick(() => this.$refs.input.focus());
        },

        async loadMessages() {
          const res = await fetch(`/api/messages/${this.currentEmail}`);
          this.messages = await res.json();
          const container = document.getElementById('chatMessages');
          container.innerHTML = '';

          if (!this.messages.length) {
            container.innerHTML = '<div class="text-gray-500 text-center">No messages yet.</div>';
          } else {
            this.messages.forEach(msg => {
              const div = document.createElement('div');
              const isSentByAdmin = msg.sender_email === '{{ user.email }}';
              div.className = isSentByAdmin
                ? "text-right text-blue-700 bg-blue-100 p-2 rounded max-w-xs ml-auto"
                : "text-left text-gray-700 bg-gray-200 p-2 rounded max-w-xs mr-auto";
              div.textContent = msg.message;
              container.appendChild(div);
            });
          }

          container.scrollTop = container.scrollHeight;
        },

        async sendMessage() {
          if (!this.newMessage.trim()) return;

          await fetch(`/api/messages/${this.currentEmail}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: this.newMessage })
          });

          this.newMessage = '';
          await this.loadMessages();
        },

        async clearChat(scope) {
          if (!confirm('Clear chat history with this user?')) return;

          if (scope === 'me') {
            await fetch(`/api/messages/clear`, {
              method: 'POST'
            });
          } else {
            await fetch(`/api/messages/${this.currentEmail}`, {
              method: 'DELETE'
            });
          }

          await this.loadMessages();
        },

        async deleteUserChat(email) {
          if (!confirm('Are you sure you want to delete this entire chat?')) return;
          await fetch(`/api/messages/${email}`, { method: 'DELETE' });
          alert("Chat deleted.");
        }
      };
    }
  </script>
</body>
</html>
